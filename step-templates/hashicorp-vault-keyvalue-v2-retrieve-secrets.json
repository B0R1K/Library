{
    "Id": "337f1b67-cdb0-4f33-9e08-6bf804f672d2",
    "Name": "HashiCorp Vault - Key/Value (v2) retrieve secrets",
    "Description": "This step retrieves one or more secrets in a v2 Key/Value secrets engine stored within a HashiCorp Vault server.\n\nSpecify fields to be returned from a secret in the format:\n\n`/secret-engine-path/secret-path fieldname | output-variable-name`\n\nwhere:\n- `/secret-engine-path/secret-path` is the full path to the secret. **Note:** This should also include the location where the [secrets engine has been enabled](https://www.vaultproject.io/api-docs/secret/kv/kv-v2).\n- `fieldname` is the name of the field value to retrieve.\n- `output-variable-name` is the _optional_ Octopus [output variable](https://octopus.com/docs/projects/variables/output-variables) name to store the value in. The default is the path to the secret and field name.\n\nFor example, if the secrets engine was enabled at `/my-secrets` and you wanted to retrieve the secret with fieldname `apikey` and it was located at the path `/config` then the value you would enter is:\n\n`/my-secrets/config apikey`\n\nMultiple secret + fields can be retrieved by entering each one on a new line.\n\nFor each secret's field values that are found, a sensitive [Output variable](https://octopus.com/docs/projects/variables/output-variables) will be created for use in other steps.\n\nThis step template makes use of the [Rest API](https://www.vaultproject.io/api-docs/secret/kv/kv-v2), so no other dependencies are needed. \n\n**Required:** \n- The Vault server must be [unsealed](https://www.vaultproject.io/docs/concepts/seal).\n- An authentication [token](https://www.vaultproject.io/docs/auth/token).\n\n\nNotes:\n\n- Tested on both PowerShell Desktop and PowerShell Core.\n- Retrieving specific versions of secret values has **not been tested**.\n\n",
    "ActionType": "Octopus.Script",
    "Version": 1,
    "CommunityActionTemplateId": null,
    "Packages": [],
    "Properties": {
      "Octopus.Action.Script.ScriptSource": "Inline",
      "Octopus.Action.Script.Syntax": "PowerShell",
      "Octopus.Action.Script.ScriptBody": "### Set TLS 1.2\n[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12\n\n# Required Variables\n$VAULT_RETRIEVE_KV_V2_SECRETS_ADDRESS = $OctopusParameters[\"Vault.Retrieve.KV.V2.Secrets.VaultAddress\"]\n$VAULT_RETRIEVE_KV_V2_SECRETS_API_VERSION = $OctopusParameters[\"Vault.Retrieve.KV.V2.Secrets.ApiVersion\"]\n$VAULT_RETRIEVE_KV_V2_SECRETS_TOKEN = $OctopusParameters[\"Vault.Retrieve.KV.V2.Secrets.AuthToken\"]\n$VAULT_RETRIEVE_KV_V2_SECRETS_LIST = $OctopusParameters[\"Vault.Retrieve.KV.V2.Secrets.SecretsList\"]\n\n# Validation\nif ([string]::IsNullOrWhiteSpace($VAULT_RETRIEVE_KV_V2_SECRETS_ADDRESS)) {\n    throw \"Required parameter VAULT_RETRIEVE_KV_V2_SECRETS_ADDRESS not specified\"\n}\nif ([string]::IsNullOrWhiteSpace($VAULT_RETRIEVE_KV_V2_SECRETS_API_VERSION)) {\n    throw \"Required parameter VAULT_RETRIEVE_KV_V2_SECRETS_API_VERSION not specified\"\n}\nif ([string]::IsNullOrWhiteSpace($VAULT_RETRIEVE_KV_V2_SECRETS_TOKEN)) {\n    throw \"Required parameter VAULT_RETRIEVE_KV_V2_SECRETS_TOKEN not specified\"\n}\nif ([string]::IsNullOrWhiteSpace($VAULT_RETRIEVE_KV_V2_SECRETS_LIST)) {\n    throw \"Required parameter VAULT_RETRIEVE_KV_V2_SECRETS_LIST not specified\"\n}\n# Helper functions\n###############################################################################\nfunction Get-WebRequestErrorBody {\n    param (\n        $RequestError\n    )\n\n    # Powershell < 6 you can read the Exception\n    if ($PSVersionTable.PSVersion.Major -lt 6) {\n        if ($RequestError.Exception.Response) {\n            $reader = New-Object System.IO.StreamReader($RequestError.Exception.Response.GetResponseStream())\n            $reader.BaseStream.Position = 0\n            $reader.DiscardBufferedData()\n            $response = $reader.ReadToEnd()\n\n            return $response | ConvertFrom-Json\n        }\n    }\n    else {\n        return $RequestError.ErrorDetails.Message\n    }\n}\n\n###############################################################################\n$VAULT_RETRIEVE_KV_V2_SECRETS_ADDRESS = $VAULT_RETRIEVE_KV_V2_SECRETS_ADDRESS.TrimEnd('/')\n\nWrite-Verbose \"########################################################\"\nWrite-Verbose \"VAULT_RETRIEVE_KV_V2_SECRETS_ADDRESS: $VAULT_RETRIEVE_KV_V2_SECRETS_ADDRESS\"\nWrite-Verbose \"VAULT_RETRIEVE_KV_V2_SECRETS_API_VERSION: $VAULT_RETRIEVE_KV_V2_SECRETS_API_VERSION\"\nWrite-Verbose \"VAULT_RETRIEVE_KV_V2_SECRETS_TOKEN: '********'\"\nWrite-Verbose \"VAULT_RETRIEVE_KV_V2_SECRETS_LIST:\"\nWrite-Verbose \"$VAULT_RETRIEVE_KV_V2_SECRETS_LIST\"\nWrite-Verbose \"########################################################\"\n\n# Local variables\n$Secrets = @()\n$VariablesCreated = 0\n$StepName = $OctopusParameters[\"Octopus.Step.Name\"]\n\n$Secrets = @(($VAULT_RETRIEVE_KV_V2_SECRETS_LIST -Split \"`n\").Trim()) | ForEach-Object {\n    if (![string]::IsNullOrWhiteSpace($_)) {\n        Write-Verbose \"Working on: '$_'\"\n        $item = ($_.TrimStart(\"/\").Trim() -Split \"\\|\")\n\n        $definition = ($item[0] -Split \" \")\n        $pathDefinition = ($definition[0] -Split \"/\")\n        if($definition.Length -le 1) {\n            throw \"Unable to establish fieldname from: '$($item[0])'\"\n        }\n        $field = $definition[1].Trim()\n        if([string]::IsNullOrWhiteSpace($field)) {\n            throw \"fieldname is null or empty, original value: '$($item[0])'\"\n        }\n        $enginePath = ($pathDefinition | Select-Object -First 1).Trim()\n        $path = (($pathDefinition | Select-Object -Skip 1) -Join \"/\").Trim()\n        \n        $secret = [PsCustomObject]@{\n            EnginePath   = $enginePath.Trim('/')\n            Path         = $path.Trim('/')\n            FieldName    = $field\n            VariableName = if (![string]::IsNullOrWhiteSpace($item[1])) { $item[1].Trim() } else { \"\" }\n        }\n        return $secret\n    }\n}\n\n$SecretsSpecified = ($Secrets.Count -gt 0)\nif ($SecretsSpecified -eq $False) {\n    throw \"No secrets could be derived from parameter values!\"\n}\n\ntry {\n    $VariablesCreated = 0\n   \n    foreach ($Secret in $Secrets) {\n        $WorkingPath = \"$($Secret.EnginePath)/$($Secret.Path)\"\n        $RequestPath = \"$($Secret.EnginePath)/data/$($Secret.Path)\"\n        $uri = \"$VAULT_RETRIEVE_KV_V2_SECRETS_ADDRESS/$VAULT_RETRIEVE_KV_V2_SECRETS_API_VERSION/$RequestPath\"\n        $headers = @{\"X-Vault-Token\" = $VAULT_RETRIEVE_KV_V2_SECRETS_TOKEN }\n\n        Write-Verbose \"Making GET request to $uri\"\n        $response = Invoke-RestMethod -Uri $uri -Headers $headers -Method GET\n\n        if ($null -ne $response) {\n            $fieldName = $Secret.FieldName\n            $value = $response.data.data.$fieldName\n            $variableName = $Secret.VariableName\n            if ($null -ne $value) {\n                Write-Verbose \"Found matching field for $($Secret.FieldName)\"\n                if ([string]::IsNullOrWhiteSpace($variableName)) {\n                    $variableName = \"$($WorkingPath.Replace(\"/\",\".\")).$($Secret.FieldName)\"\n                    Write-Verbose \"No output variable name specified for $($Secret.FieldName). Using generated name of '$($variableName)'.\"\n                }\n                \n                Set-OctopusVariable -Name $variableName -Value $value -Sensitive\n                Write-Highlight \"Created output variable: ##{Octopus.Action[$StepName].Output.$variableName}\"\n                $VariablesCreated += 1\n            }\n        }  \n        else {\n            Write-Error \"Null or Empty response returned from path: $WorkingPath\" -Category InvalidResult\n        } \n    }\n}\ncatch {\n    $ExceptionMessage = $_.Exception.Message\n    $ErrorBody = Get-WebRequestErrorBody -RequestError $_\n    $Message = \"An error occurred retrieving secrets from path: $WorkingPath - $ExceptionMessage\"\n    if ($null -ne $ErrorBody.errors) {\n        $AdditionalDetail += $ErrorBody.errors -Join \",\"\n    }\n    else {\n        $AdditionalDetail += $ErrorDetails\n    }\n    if (![string]::IsNullOrWhiteSpace($AdditionalDetail)) {\n        $Message += \"`n`tDetail: $AdditionalDetail\"\n    }\n\n    Write-Error $Message -Category ReadError\n}\n\nWrite-Host \"Created $variablesCreated output variables\""
    },
    "Parameters": [
      {
        "Id": "a38edf0b-0e90-4421-97d3-688391887f9c",
        "Name": "Vault.Retrieve.KV.V2.Secrets.VaultAddress",
        "Label": "Vault Server URL",
        "HelpText": "The URL of the Vault instance you are connecting to. Port should be included (The default is `8200`). For example:\n\n\n`https://myvault.local:8200/`",
        "DefaultValue": "",
        "DisplaySettings": {
          "Octopus.ControlType": "SingleLineText"
        }
      },
      {
        "Id": "0ab319fd-2d90-4f61-b529-cd682bc590a3",
        "Name": "Vault.Retrieve.KV.V2.Secrets.ApiVersion",
        "Label": "API version",
        "HelpText": "All API routes are prefixed with a version e.g. `/v1/`.\n\nSee the [API documentation](https://www.vaultproject.io/api-docs) for further details.",
        "DefaultValue": "v1",
        "DisplaySettings": {
          "Octopus.ControlType": "Select",
          "Octopus.SelectOptions": "v1|v1"
        }
      },
      {
        "Id": "b4922053-38da-4092-ac45-fc1551c65254",
        "Name": "Vault.Retrieve.KV.V2.Secrets.AuthToken",
        "Label": "Auth Token",
        "HelpText": "The [Auth Token](https://www.vaultproject.io/docs/auth/token) used to authenticate to retrieve secrets.",
        "DefaultValue": "",
        "DisplaySettings": {
          "Octopus.ControlType": "Sensitive"
        }
      },
      {
        "Id": "076af34e-cd40-495a-b4a0-a478fd0308aa",
        "Name": "Vault.Retrieve.KV.V2.Secrets.SecretsList",
        "Label": "Secrets",
        "HelpText": "Specify fields to be returned from a secret in the format:\n\n`/secret-engine-path/secret-path fieldname | output-variable-name`\n\nwhere:\n- `/secret-engine-path/secret-path` is the full path to the secret. **Note:** This should also include the location where the [secrets engine has been enabled](https://www.vaultproject.io/api-docs/secret/kv/kv-v2).\n- `fieldname` is the name of the field value to retrieve.\n- `output-variable-name` is the _optional_ Octopus [output variable](https://octopus.com/docs/projects/variables/output-variables) name to store the value in. The default is the path to the secret and field name.\n\nFor example, if the secrets engine was enabled at `/my-secrets` and you wanted to retrieve the secret with fieldname `apikey` and it was located at the path `/config` then the value you would enter is:\n\n`/my-secrets/config apikey`\n\nMultiple secret fields can be retrieved by entering each one on a new line.\n",
        "DefaultValue": "",
        "DisplaySettings": {
          "Octopus.ControlType": "MultiLineText"
        }
      }
    ],
    "LastModifiedAt": "2021-04-13T08:38:44.521Z",
    "LastModifiedBy": "harrisonmeister",
    "$Meta": {
      "ExportedAt": "2021-04-13T08:38:44.521Z",
      "OctopusVersion": "2021.1.6966",
      "Type": "ActionTemplate"
    },
    "Category": "hashicorp-vault"
  }